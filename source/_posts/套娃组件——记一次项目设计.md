---
title: 套娃组件——记一次项目设计
date: 2017-05-13 17:56:56
tags: ['项目设计']
---

# 背景
近期，接到一个项目，商业产品引入新的券种————时长券。大致的交互和以往的现金券差不不多，仅仅是优惠券的数据结构不同，展示的弹框样式也有所不同。
下图是时长券弹框的样式：
![](/img/时长券弹框样式.png)

# 分析
* 偷懒方案
大可将现金券的交互逻辑拷贝一份，装饰一个新的模板，留意券的数据结构，调整个别个性化交互即可。
预估两三天即可，很轻松。

缺点：代码通过剪刀胶水一番操作后，重复大片，如果下次需要调整优惠券的一些逻辑时，相当于我要改两次。另外，弹框的交互和优惠券的业务掺杂在一起了。耦合度较高。

* 自找麻烦方案
静下心，认真分析现金券和时长券之间共同点，思考是否可以将它们共同部分单独抽离出来。
比如弹框的左右翻页，就可以抽离出来作为弹框本身的事件处理，与何种券没有关系。


# 套娃组件
本着不给自己挖坑的原则，有必要好好设计一下。想到俄罗斯的玩具————套娃，既然两种券弹框样式和交互大多一致，就可以将共同部分抽离出为一个弹框组件。弹框组件维护自己的样式和交互，它并不关心优惠券的类别。
现金券弹框和时长券弹框都可继承自这个基础弹框，它们仅负责自己业务行为，将需要展示的优惠券列表通过参数形式传入到基础弹框组件中。
这就像一个套娃套住了另一个套娃。
在实际开发中，也尽量将基础弹框组件做成热拔插的组件，这样也可以应对以后业务扩展的需要，比如以后再引入其他券种，就可以继承自基础组件，而仅关心业务需求即可。

# 设计
依据上面的思路，画出以下设计框架，以继承封装的形式层层套组件
![](/img/优惠券套娃组件设计.png)

由于基础弹框组件已经封装了弹框的交互行为，当弹框点击行为触发时，比如翻页，它需要读取到下一页的数据并展示，那么通知券组件获取展示数据。此时需要为组件之间的通信架起桥梁。
我的解决方案是观察者模式，又称订阅发布模式。当基础弹框组件触发相关事件时，可以立即抛出消息，券组件就可以监听到这个消息，从而准备好相关数据，再次调用基础弹框组件暴露的方法更新视图。大致流程图如下：
![](/img/时长券组件消息通知.png)

1.基础弹框组件继承观察者类(Observer)，在基础弹框组件的关键行为中，如翻页事件，会触发消息：
```js
this.trigger('go_page', [page])
```
2.券组件初始化时，会监听来自基础弹框组件的消息，并依据消息完成业务逻辑，如翻页消息:
```js
var self = this
self.on('go_page', function(page){
    // get coupon list according to page paramater
    self._common.goPage(page)
})
```
3.券组件在实例化基础弹框组件时，可以传入一些钩子函数，这些钩子函数的作用是在弹框组件一些事件中执行券组件个性化需求。
比如基础弹框组件不关心券列表，其中显示的表格样式也可以由券组件配置，那么基础弹框组件在渲染券列表时，并不知道它的数据结构，因此可以调起传入的优惠券渲染钩子函数，这样渲染个性化的模板任务交给了券组件。
如果钩子函数参数是空的，那么基础弹框组件就会执行默认行为。
以下代码片段是计算使用优惠券后计算优惠信息，其中`calDiscountHook`就是一个钩子。当计算完毕后，还会抛出`calculate`消息告知券组件已计算完毕，可以执行一些额外的工作。（添加`eventPrefix`为的防止消息重名）
```js
/**
 * [calculate 计算优惠信息]
 * @return {number}    [折后价]
 */
Common.prototype.calculate = function () {
    var self = this,
        discount = 0
    _.each(self._choosen, function (coupon) {
        // 可以指定计算优惠信息的钩子函数，方便自定义。默认读取discountValue字段
        discount += ( self._op.calDiscountHook ? +self._op.calDiscountHook(coupon) : (+coupon.discountValue || 0) )
    })
    discount = toFixed(discount, 2)
    self._updateDiscount(discount)
    // 如果你需要自定义更新显示优惠信息，你可以去监听这个事件
    self.trigger(self._op.eventPrefix + 'calculate', [self._choosen, discount])
    return discount
}
```
